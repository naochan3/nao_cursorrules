---
alwaysApply: true
---
Description: Cursor Agentが使用可能なツールの利用方針、安全基準、および並列実行のガイドラインを定義します。コード変更やコマンド実行の前に必ず参照し、安全で効率的な操作を保証してください。

# 🛡️ ツール利用ポリシー (Tool Usage Policy)

## 1. 基本方針 (Core Principles)
- **読み取り先行 (Read First)**: ファイルを変更する前は、必ず `read_file` で現状を確認してください。思い込みでの変更は厳禁です。
- **実行確約 (Action Oriented)**: ユーザーから「実装して」と指示された場合、提案だけで終わらせず、`apply_patch` 等を使用して実際にコードを変更してください。
- **安全性 (Safety)**: 破壊的な変更や、元に戻せない操作を行う前には必ず確認を行ってください。

## 2. ツール別ガイドライン

### 2.1 ファイル操作 (File Operations)
- **`read_file`**:
    - 変更対象のファイルだけでなく、関連する型定義やインポート元のファイルも確認してください。
    - 巨大なファイルの場合は、`grep` で当たりをつけてから必要な範囲のみを読み込むなど、トークン節約を意識してください。
- **`apply_patch` / `edit_file`**:
    - コード変更の第一手段として使用してください。
    - 一度の変更は「意味のある最小単位」に留め、複数の異なる責務の変更を混ぜないでください。
    - 変更後は必ず構文エラーがないか確認してください（可能なら `read_lints` を使用）。

### 2.2 検索・調査 (Search & Exploration)
- **`grep`**:
    - 特定の関数名、変数名、エラーメッセージなど、完全一致する文字列を探す場合に使用してください。
- **`codebase_search`**:
    - 「認証の仕組みはどうなっている？」「この機能はどこで実装されている？」といった、意味的な検索に使用してください。

### 2.3 ターミナル実行 (Terminal Execution)
- **`run_terminal_cmd`**:
    - ユーザーの明示的な指示がある場合、またはビルド・テスト・Lint実行が必要不可欠な場合に使用してください。
    - **対話モード回避**: `npm install` や `apt-get` など、ユーザー入力を求める可能性があるコマンドには必ず `--yes` や `-y` フラグを付けてください。
    - **バックグラウンド実行**: サーバー起動など、長時間実行されるコマンドは `is_background: true` を設定してください。

### 2.4 ウェブ検索 (Web Search)
- **`web_search`**:
    - 以下のケースでは、ユーザーの指示がなくても積極的に検索を行ってください。
        - ライブラリやフレームワークの**最新バージョンでの破壊的変更**が疑われる場合
        - 外部API（Supabase, OpenAI, Stripe等）の**最新仕様や制限**を確認する場合
        - 未知のエラーメッセージや、独自の解決策が見当たらないバグに遭遇した場合
    - 検索を行った際は、「何を検索し、何が分かったか」を1〜2行で簡潔に報告してください。

## 3. 並列実行ガイドライン (Parallel Execution)

### ✅ 並列実行OK
依存関係のない**読み取り系ツール**は、積極的に `multi_tool_use.parallel` で並列実行し、応答速度を向上させてください。
- `read_file` + `read_file`
- `grep` + `codebase_search`
- `web_search` + `read_file`

### ❌ 並列実行NG
**状態を変更するツール**を含む操作は、順序性を保証するため並列実行しないでください。
- `apply_patch` + `read_file` (変更後の内容を読む必要があるため)
- `apply_patch` + `apply_patch` (競合の恐れがあるため)
- `run_terminal_cmd` (ファイル作成) + `read_file`

## 4. エラーハンドリングと自己修復
- **自己修復プロトコル (Self-Healing Protocol)**:
    - エラーが発生した場合、以下のループを最大3回まで自律的に回すことを許可します。ユーザーに都度報告する必要はありません。
    1. **Diagnosis**: エラーログを読み、原因を特定する。
    2. **Fix**: 修正パッチを適用する。
    3. **Verify**: テストを実行し、修正されたか確認する。
    - 3回試行しても解決しない場合のみ、状況を整理してユーザーに報告し、指示を仰いでください。
- **Lint/型エラー**: 自身が導入した変更により発生したエラーは、可能な限りその場で修正してください。
- **any型の禁止**: エラーを回避するためだけに `any` を使用することは禁止です。一時的な回避が必要な場合は `unknown` を使用し、`TODO` コメントを残してください。

## 5. MCP (Model Context Protocol) 活用ガイドライン
調査フェーズにおいて、MCPツール（外部データ連携）へのアクセスが許可されている場合は、推測で回答する前に必ず「一次情報」を取りに行ってください。

1. **データベース調査**:
   - `supabase_list_tables`, `supabase_execute_sql` 等を使用し、実際のスキーマ定義とデータ構造を確認してからコードを書くこと。
   - 「スキーマはどうなっていますか？」とユーザーに聞く前に、ツールで調べること。

2. **ドキュメント検索**:
   - `supabase_search_docs` などを活用し、ライブラリの最新仕様を確認すること。学習データが古い可能性を常に疑うこと。
