---
description: プロジェクトのフェーズや規模に応じたテスト戦略と自動化の方針を定義します。テストコードを書く前に必ず参照してください。
globs: ["**/*.test.ts", "**/*.spec.ts", "**/*.test.tsx", "vitest.config.ts", "jest.config.js"]
---

# 27. テスト戦略 (Testing Strategy)

- Description: 「全てのバグをゼロにする」ことではなく、「開発速度を落とさずに、変更に対する恐怖を取り除く」ことを目的としたテスト戦略です。フェーズ（MVP/Stable）に応じて、投資すべきテストの種類と量を最適化してください。

# 1. テストの階層と優先順位 (Testing Pyramid)

リソースは有限です。以下の比率を目安にテストを実装してください。

- **Level 1: Unit Test (60-70%)**
    - **対象**: 純粋関数、複雑なビジネスロジック、ユーティリティ、カスタムフック。
    - **特徴**: 高速、低コスト、壊れにくい。
    - **AIへの指示**: 「このユーティリティ関数のエッジケース（境界値、null、空配列など）を網羅する単体テストを書いて。」

- **Level 2: Integration Test (20-30%)**
    - **対象**: APIエンドポイント、データベース連携、主要なコンポーネント結合部。
    - **特徴**: モックを最小限にし、実際のDBやサービスとの連携を確認する。
    - **AIへの指示**: 「このAPIエンドポイントに対して、正常系と、DB接続エラー時の異常系の統合テストを書いて。DBはテスト用コンテナを使用すること。」

- **Level 3: E2E Test (10%)**
    - **対象**: クリティカルなユーザーフロー（サインアップ、決済、主要機能の完遂）。
    - **特徴**: メンテナンスコストが高い。壊れやすい。「Happy Path（正常系）」のみに絞る。
    - **AIへの指示**: 「ユーザーがログインして商品をカートに入れ、決済完了画面に到達するまでのHappy PathのみをPlaywrightで記述して。」

# 2. フェーズ別許容ライン (Phase Strategy)

## 2.1 MVP / プロトタイプフェーズ
- **戦略**: 「スピード優先」。変更が激しいため、壊れやすいテストは負債になる。
- **必須**:
    - コアロジックの単体テスト
    - ログイン/決済など、事業的に死ぬと困る箇所のE2E (Happy Pathのみ)
- **不要**:
    - 細かいUIコンポーネントのテスト
    - 網羅的な統合テスト

## 2.2 Growth / Stableフェーズ
- **戦略**: 「安定性優先」。リファクタリングの安全網を確保する。
- **追加**:
    - 統合テストのカバレッジ向上
    - バグ再現テスト（バグが見つかったら、まずテストを書いて再現させてから直す）
    - Visual Regression Testing (UIの崩れ検知)

# 3. テスト実装のベストプラクティス

- **AAAパターン**: Arrange（準備）、Act（実行）、Assert（検証）を明確に分けて記述する。
- **テストデータ**: 固定のフィクスチャではなく、ファクトリーパターン（FactoryBot的なもの）を使用して動的に生成することを推奨。
- **モックの原則**:
    - **外部システム（Stripe, SendGridなど）**: 必ずモックする。
    - **内部DB**: 可能な限りモックせず、Docker上のテストDBを使う（信頼性確保）。
- **ユーザー視点のクエリ**: `getByTestId` よりも `getByRole`, `getByText` など、ユーザーが認識できる要素で要素を取得する（Testing Libraryの哲学）。

# 4. AIへの指示出しテンプレート

テストコード生成を依頼する際は、以下の情報を明示してください。

```markdown
以下のコードのテストを作成してください：
1. **対象ファイル**: `src/services/payment.ts`
2. **テスト種類**: 単体テスト (Vitest)
3. **カバレッジ要件**: 正常系だけでなく、在庫不足・カードエラーなどの異常系も網羅して。
4. **モック**: StripeのAPI呼び出しはモックして。
```

# 5. CI/CD連携
- プルリクエスト作成時に、自動で Unit Test と Lint が走るように設定します。
- E2Eテストは時間がかかるため、マージ時または夜間実行などに分離することを検討してください。
