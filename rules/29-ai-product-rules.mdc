---
description: AI機能をプロダクトに実装する際の設計原則、プロンプト管理、安全基準を定義します。Cursor自体の設定ではなく、プロダクトとしてのAI機能開発に適用されます。
globs: ["**/*ai*", "**/*llm*", "prompts/**/*.ts", "openai.ts", "anthropic.ts"]
---

# 29. AIプロダクト開発ルール (AI Product Rules)

- Description: AI（LLM）を組み込んだ機能を開発する際の、プロンプト設計、品質管理、リスク対策に関するガイドラインです。AIは確率的に動作するため、決定論的なシステムとは異なるアプローチが必要です。

# 1. プロンプトエンジニアリング標準

コード内に散らばるプロンプト文字列（マジックストリング）は管理不能になります。必ず以下の構造で管理してください。

## 1.1 プロンプト管理構造
- **配置**: `src/prompts/` や `src/lib/ai/prompts/` などに集約する。
- **構成要素**:
    - **System Prompt**: AIの役割、制約条件、出力形式（JSONなど）を定義。
    - **User Context**: ユーザーの入力や、動的に挿入されるデータ。
    - **Few-Shot Examples**: 期待する入出力の具体例（精度向上のため必須級）。

## 1.2 System Prompt テンプレート
```markdown
あなたは {Role} です。
以下の制約条件（Constraints）を厳守し、ユーザーの要求に応えてください。

# Constraints
- 出力は必ず日本語で行ってください。
- 回答は {Format} 形式のJSONのみを出力してください。Markdownや説明文は不要です。
- わからない場合は嘘をつかず「不明」と回答してください（ハルシネーション防止）。

# Tone & Style
- 簡潔に、客観的な事実のみを述べてください。
```

# 2. AIの不確実性への対策

## 2.1 構造化出力の強制 (Structured Output)
- AIの出力をプログラムで処理する場合、自由記述テキストではなく、必ず **JSON Schema** や **Function Calling** を使用して構造化データを強制してください。
- `zod` などのバリデーションライブラリで、AIの出力が期待する型に合致しているか必ずチェックし、失敗時のリトライ/フォールバック処理を実装してください。

## 2.2 フォールバックとUI/UX
- **Streaming**: 生成に時間がかかる場合は、必ずストリーミング表示を行い、体感待ち時間を減らしてください。
- **楽観的UI**: AI処理中もユーザーが操作を続けられるような設計を検討してください。
- **失敗時のUX**: AIがエラーを返したり、意味不明な回答をした場合に、ユーザーにそのままエラーを見せるのではなく、「生成できませんでした」等のマイルドな表現にするか、ルールベースの処理に切り替えてください。

# 3. 安全性と倫理 (Safety & Ethics)

- **Injection対策**: ユーザー入力をそのままプロンプトに埋め込む際は、区切り文字（`"""`など）で囲むなどして、プロンプトインジェクション対策を行ってください。
- **センシティブデータ**: 個人情報や機密情報をLLMに送信する前に、ローカルでマスキング処理を行うか、エンタープライズ契約（学習に利用されない設定）が有効なAPIのみを使用してください。

# 4. モデル更新と評価

- **モデルの固定**: `gpt-4` のようなエイリアスではなく、`gpt-4-0613` のように特定バージョンを指定し、勝手な挙動変化を防いでください。
- **評価セット (Evals)**: プロンプトを変更した際に、以前の良さが失われていないかを確認するための「ゴールデンデータセット（入力と理想的な出力のペア）」を最低10件作成し、変更のたびにテストしてください。

# 5. AIへの指示

- 「この機能のためのSystem Promptを作成して。役割は『優秀な編集者』で、ユーザーの文章を『要約』し、JSON形式で返すもの。」
- 「OpenAI APIを呼ぶ処理を実装して。レスポンスはZodスキーマでバリデーションし、失敗したら最大2回リトライするロジックを入れて。」
