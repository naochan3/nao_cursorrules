---
description: ログ出力、モニタリング、エラー追跡の標準ルールを定義します。運用時のトラブルシューティング効率を最大化するために参照してください。
globs: ["**/*.ts", "**/*.js", "logging-config.ts", "logger.ts"]
---

# 28. 可観測性とロギング (Observability & Logging)

- Description: 「何かあったとき」に、エンジニアが迷わず原因に辿り着けるためのログ設計ルールです。テキストログではなく「構造化ログ」を基本とし、検索・分析可能な状態を維持します。

# 1. ログ出力ポリシー (Logging Policy)

## 1.1 構造化ログ (Structured Logging)
- **原則**: ログは人間が読むテキストではなく、機械が解析するデータです。
- **形式**: 原則として **JSON形式** で出力してください。
- **必須フィールド**:
    - `level`: ログレベル
    - `message`: 人間が読むための概要
    - `timestamp`: ISO 8601形式
    - `correlationId` / `traceId`: リクエスト追跡用ID
    - `context`: 関連データ（userId, orderIdなど）

**NG (テキストログ):**
```javascript
console.log("Error: User " + userId + " failed to pay.");
```

**OK (構造化ログ):**
```javascript
logger.error("Payment failed", {
  userId: "user_123",
  error: error.message,
  stack: error.stack,
  orderId: "order_abc"
});
```

## 1.2 ログレベル基準 (Log Levels)
- **ERROR**: 即時対応が必要な障害。システムが正しく動作していない。
    - 例: DB接続断、決済失敗、未捕捉の例外。
    - アクション: Slack/PagerDutyへ即時通知。
- **WARN**: 正常ではないが、システムは稼働している。または将来のエラーの予兆。
    - 例: 4xxエラーの多発、非推奨APIの使用、リトライ発生。
    - アクション: 定期的なレビュー。
- **INFO**: 正常な操作の記録。ビジネス上の重要イベント。
    - 例: ログイン成功、注文確定、バッチ処理完了。
    - アクション: 分析用ダッシュボードへの反映。
- **DEBUG**: 開発・トラブルシューティング詳細。本番では通常抑制する。
    - 例: リクエスト/レスポンスのペイロード全文、変数の内容。

# 2. 個人情報保護 (PII Redaction)

- **鉄の掟**: パスワード、クレジットカード番号、認証トークン、個人特定情報（PII）は **絶対にログに出力しないでください**。
- **対策**:
    - ロガーのミドルウェア層で、特定のキー（`password`, `token`, `credit_card`）を自動的にマスク（`***`）する処理を入れてください。

# 3. エラーハンドリングと通知

- **エラーの握りつぶし禁止**: `try-catch` してもログを出さずに処理を続けるのは最悪のアンチパターンです。必ずログ出力するか、上位へスローしてください。
- **コンテキストの付与**: エラーをラップする際は、必ず元のエラー原因（Cause）と、その時の状況（引数など）を含めてください。

# 4. クラウド監視設計 (GCP/CloudWatch)

- `20-gcp-deploy-complete-guide.mdc` と連携し、以下の設定を行ってください。
    - **Cloud Logging**: アプリケーションログの集約。
    - **Cloud Monitoring**:
        - **死活監視**: `/health` エンドポイントへの定期チェック。
        - **エラーレート**: 5xxエラーが一定閾値を超えたらアラート。
        - **レイテンシ**: 95/99パーセンタイル値の監視。

# 5. AIへの指示

- 「このAPIの実装に、Pino（またはWinston）を使った構造化ログ処理を追加して。リクエスト開始時と終了時、エラー発生時には必ずログを出すこと。」
- 「このエラーハンドリング、`console.error`ではなく、コンテキスト情報（ユーザーID、入力値）を含めた形でロガーを呼ぶように修正して。」
