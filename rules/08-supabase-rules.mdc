---
alwaysApply: false
---
Description: BaaSであるSupabaseを利用する際の、セキュリティ、データ操作、認証に関するルールを定義します。Supabaseのクライアントライブラリを扱うコードについて質問があった場合に、このルールを適用してください。

# 1. クライアントの初期化は環境変数で行う
- **考え方**: SupabaseのURLと`anon`キー（場合によっては`service_role`キー）は機密情報です。これらは`.env`ファイルに記述し、`process.env`経由で安全に読み込みます。特に、サーバーサイドで使う`service_role`キーは絶対に外部に漏らしてはいけません。
- **AIへの指示**: 「Supabaseのクライアントを初期化するコードを生成して。URLとanonキーは環境変数から取得するように。」

# 2. Row Level Security (RLS) を常に意識する
- **考え方**: Supabaseのセキュリティの根幹は、データベースレベルでの行単位のアクセスポリシー(RLS)です。RLSを有効にしないテーブルは、基本的に全世界に公開されているのと同じです。「このデータは誰が見れるべきか？」を常に考え、テーブル作成時には必ずRLSを有効にし、適切なポリシーを設定しましょう。
- **AIへの指示**: 「`profiles`テーブルを作成するSQLを書いて。全てのユーザーは自分のプロフィールしか閲覧・編集できないように、RLSポリシーも一緒に設定してほしい。」

# 3. データの取得は select() で明示的にカラムを指定する
- **考え方**: `select('*')`は、簡単ですが非効率で、意図しないデータ（例えば、他のユーザーの個人情報など）を取得してしまうリスクがあります。必要なカラムだけを明示的に指定することで、パフォーマンスが向上し、セキュリティも高まります。
- **悪い例**: `supabase.from('posts').select('*')`
- **良い例**: `supabase.from('posts').select('id, title, created_at')`
- **AIへの指示**: 「投稿一覧を取得するSupabaseのクエリを書いて。必要なのは`id`と`title`だけです。」

# 4. 全てのクエリでエラーハンドリングを行う
- **考え方**: Supabaseのクライアントライブラリからの応答は `{ data, error }` という形式のオブジェクトです。データ操作が成功したと思い込まず、必ず`error`オブジェクトが`null`であるかを確認する習慣をつけましょう。
- **実践方法**:
    ```javascript
    const { data, error } = await supabase.from('countries').select();
    if (error) {
      console.error('Error fetching countries:', error);
      // ユーザーにエラーを通知する処理
      return;
    }
    // dataを使った処理
    ```
- **AIへの指示**: 「Supabaseでユーザープロフィールを更新する関数を書いて。成功した場合と、エラーが発生した場合の両方を適切に処理するようにして。」

# 5. 認証はSupabaseの組み込み機能に任せる
- **考え方**: ユーザー認証の仕組みを自前で実装するのは非常に複雑で、セキュリティリスクが伴います。Supabaseは`signUp`, `signInWithPassword`, `signOut`, `onAuthStateChange`といった強力で安全な認証ヘルパーを提供しているので、これらを最大限に活用しましょう。
- **AIへの指示**: 「Supabase Authを使った、メールアドレスとパスワードでのサインアップ機能の実装例を教えて。」

# 6. Edge Functions の使い分け
- **考え方**: 全てのロジックをクライアント側に書くのはセキュリティ上危険ですし、全てをSQL（PL/pgSQL）で書くのは保守性が低いです。
- **使い分け基準**:
    - **Database Webhooks**: データの変更（INSERT/UPDATE）をトリガーに外部APIを叩く場合や、軽量な通知処理。
    - **Edge Functions (Deno)**: Stripe決済、OpenAI API呼び出し、複雑なビジネスロジック、定期実行（Cron）が必要な処理。
    - **Client Side**: UIの表示制御、単純なCRUD操作。
- **AIへの指示**: 「ユーザーが画像をアップロードした後に、自動的にサムネイルを生成したい。これはDatabase Webhookでやるべき？それともEdge Functions？理由と一緒に教えて。」