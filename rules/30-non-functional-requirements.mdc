---
description: パフォーマンス、セキュリティ、信頼性などの「非機能要件」に関する定量的な目標値と合格ラインを定義します。設計やリリース判断の基準として使用します。
globs: ["**/*.ts", "**/*.tsx", "next.config.js", "infra/**/*"]
---

# 30. 非機能要件と合格ライン (Non-Functional Requirements)

- Description: 「機能が動く」だけでなく、「どれだけ快適・安全・安定して動くか」の基準値（SLO/SLI）を定義します。これらは努力目標ではなく、これを下回ると「バグ」とみなされる品質基準です。

# 1. パフォーマンス (Performance)

## 1.1 Core Web Vitals (Frontend)
Googleの基準に準拠し、ユーザー体験を損なわない速度を維持します。
- **LCP (読み込み)**: **2.5秒以内** (Good)
- **INP (応答性)**: **200ms以内** (Good)
- **CLS (視覚的安定性)**: **0.1以下** (Good)

## 1.2 API Latency (Backend)
- **同期API (ユーザー操作に直結)**: p95 (95%のリクエスト) が **500ms以内**。理想は200ms以内。
- **非同期/検索API**: p95 が **2秒以内**。それ以上かかる場合はローディングUIや非同期処理（Job Queue）への移行を検討する。

# 2. 可用性と信頼性 (Availability & Reliability)

- **稼働率目標 (SLO)**: **99.9%** (月間ダウンタイム約43分以内)。
- **エラーレート**: 5xxエラーが全リクエストの **0.1%未満** であること。
- **RPO (目標復旧時点)**: データベースのバックアップは **毎日（またはPITR有効化）** 取得し、最悪でも24時間前の状態に戻せること。
- **RTO (目標復旧時間)**: 障害発生から **4時間以内** にサービスを復旧できる手順が確立されていること。

# 3. セキュリティ (Security)

- **OWASP Top 10**: `23-security-policy.mdc` に従い、既知の脆弱性対策が行われていること。
- **通信**: 全ての通信が **HTTPS (TLS 1.2以上)** であること。
- **認証**: パスワードポリシー（8文字以上、複雑性要件）またはソーシャルログイン/パスワードレス認証の実装。
- **依存関係**: `npm audit` で Critical/High の脆弱性がゼロであること。

# 4. 拡張性とコスト (Scalability & Cost)

- **スケール戦略**:
    - **Stateless**: アプリケーションサーバーはステートレスに保ち、水平スケール（台数増減）可能にする。
    - **Database**: コネクションプーリング（Supabase Transaction Poolなど）を利用し、DB接続数枯渇を防ぐ。
- **コスト意識**:
    - アイドル状態のリソース（開発環境のDBなど）は停止または最小構成にする。
    - 定期的なコスト監視アラートを設定する。

# 5. AIへの指示

- 「この画像の読み込み処理、LCPに悪影響を与えないように`Priority`属性をつけるか、適切な最適化を行って。」
- 「APIのレスポンスタイムが1秒を超えている。N+1問題が起きていないか調査し、500ms以内に収まるようにチューニングして。」
- 「現在の構成で、月間10万PVまでスケールした場合のボトルネックになりそうな箇所を指摘して。」
