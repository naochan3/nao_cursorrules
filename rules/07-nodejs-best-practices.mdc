---
alwaysApply: false
---
Description: Node.js (特にExpress, Hono, NestJSなど) を使ったサーバーサイド開発における、セキュリティ、エラーハンドリング、コード構成に関するベストプラクティスを定義します。

# 0. ランタイムとバージョン
- **Node.jsバージョン**: 本番環境では必ず **Active LTS (Long Term Support)** バージョンを使用してください（現在は Node.js 20 または 22）。奇数バージョンは開発用であり、本番では避けます。
- **TypeScript First**: 新規プロジェクトは必ず TypeScript で開始します。実行には `tsx` (開発時) や `tsc` ビルド (本番時) を使用します。

# 1. 環境変数で設定を外部化する
- **考え方**: データベースの接続情報、APIキー、ポート番号などの設定値は、絶対にコードに直接書き込んではいけません。
- **実践方法**:
    - `dotenv`ライブラリを使用し、プロジェクトルートに`.env`ファイルを作成して機密情報を記述します。
    - `.gitignore`ファイルに`.env`を必ず追加します。
    - TypeScriptでは `process.env` に型安全性を持たせるため、`zod` などで環境変数を検証・パースすることを強く推奨します。
    ```typescript
    const envSchema = z.object({
      DATABASE_URL: z.string().url(),
      PORT: z.coerce.number().default(3000),
    });
    export const env = envSchema.parse(process.env);
    ```

# 2. エラーハンドリングを徹底する
- **考え方**: サーバーサイドのアプリケーションは、予期せぬエラーでクラッシュしてはいけません。
- **実践方法**:
    - 全ての非同期処理は `try...catch` ブロックで囲むか、Promiseチェーンで適切に処理します。
    - Express v5以降やHonoでは非同期エラーが自動的にキャッチされますが、それ以前のバージョンでは必ず `next(error)` を呼び出します。
    - グローバルなエラーハンドリングミドルウェアで、ログ出力とレスポンス整形を一元管理します。

# 3. 非同期処理は `async/await` で統一する
- **考え方**: `async/await`構文を使うことで、可読性を高めます。トップレベルawaitも活用してください。

# 4. モジュールシステム (ES Modules)
- **考え方**: CommonJS (`require`) ではなく、ES Modules (`import`/`export`) を使用します。
- **設定**: `package.json` に `"type": "module"` を追加するか、TypeScriptの設定 (`tsconfig.json`) で `module: "NodeNext"` 等を指定して、モダンなモジュールシステムを利用します。

# 5. アーキテクチャ構成 (Layered Architecture)
- **考え方**: コードの責務を分離し、テスト容易性と保守性を高めます。コントローラーにビジネスロジックを詰め込むのはアンチパターンです。
- **構成レイヤー**:
    1. **Controller**: リクエストの受付、バリデーション、レスポンスの返却のみを担当。ビジネスロジックは書かない。
    2. **Service**: ビジネスロジック（計算、判断、複数リソースの整合性管理）を担当。
    3. **Repository**: データベースへのクエリ実行のみを担当。SQLやORMの操作はここに隠蔽する。
- **AIへの指示**: 「このAPI、ロジックがControllerにベタ書きされていて太りすぎている。Service層とRepository層に分離して、単体テストをしやすくリファクタリングして。」